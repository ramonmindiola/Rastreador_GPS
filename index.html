<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Tracker - Monitoreo en Tiempo Real</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            height: 80vh;
        }

        .sidebar {
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 30px;
            overflow-y: auto;
        }

        .sidebar h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #27ae60;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .device-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .device-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .device-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3498db, #2ecc71);
        }

        .device-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
            border-color: #3498db;
        }

        .device-card.active {
            border-color: #e74c3c;
            background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
        }

        .device-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .device-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .info-label {
            font-weight: 500;
        }

        .info-value {
            color: #2c3e50;
            font-weight: 600;
        }

        .coordinate {
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }

        .timestamp {
            color: #27ae60;
            font-weight: bold;
        }

        .map-container {
            position: relative;
            height: 100%;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            flex-direction: column;
            gap: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px;
            text-align: center;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #3498db, #2ecc71);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .info-window {
            max-width: 300px;
            padding: 10px;
        }

        .info-window h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }

        .info-window .detail {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .info-window .label {
            font-weight: bold;
            color: #34495e;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: 300px 1fr;
            }
            
            .sidebar {
                max-height: 300px;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ∞Ô∏è GPS Tracker</h1>
            <p>Monitoreo en Tiempo Real de Dispositivos GPS</p>
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <h2>
                    <span class="status-indicator"></span>
                    Dispositivos Activos
                </h2>
                <div id="deviceList" class="device-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando dispositivos...</p>
                    </div>
                </div>
                <button class="refresh-btn" onclick="refreshData()">
                    üîÑ Actualizar
                </button>
            </div>
            
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
    
    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBW7fJ0ke1KmbyuU22j2et3Hv4pjjdTgao",
            authDomain: "proyecto-gps-bdc43.firebaseapp.com",
            databaseURL: "https://proyecto-gps-bdc43-default-rtdb.firebaseio.com",
            projectId: "proyecto-gps-bdc43",
            storageBucket: "proyecto-gps-bdc43.firebasestorage.app",
            messagingSenderId: "815468678002",
            appId: "1:815468678002:web:fd556a89ca8ea0a8896beb"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Variables globales
        let map;
        let markers = {};
        let selectedDevice = null;
        let devicesData = {};

        // Inicializar mapa
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 10,
                center: { lat: 0.0, lng: -78.0 }, // Coordenadas de Ecuador
                styles: [
                    {
                        "featureType": "all",
                        "elementType": "geometry.fill",
                        "stylers": [{"weight": "2.00"}]
                    },
                    {
                        "featureType": "all",
                        "elementType": "geometry.stroke",
                        "stylers": [{"color": "#9c9c9c"}]
                    },
                    {
                        "featureType": "all",
                        "elementType": "labels.text",
                        "stylers": [{"visibility": "on"}]
                    },
                    {
                        "featureType": "landscape",
                        "elementType": "all",
                        "stylers": [{"color": "#f2f2f2"}]
                    },
                    {
                        "featureType": "landscape",
                        "elementType": "geometry.fill",
                        "stylers": [{"color": "#ffffff"}]
                    },
                    {
                        "featureType": "landscape.man_made",
                        "elementType": "geometry.fill",
                        "stylers": [{"color": "#ffffff"}]
                    },
                    {
                        "featureType": "poi",
                        "elementType": "all",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "road",
                        "elementType": "all",
                        "stylers": [{"saturation": -100}, {"lightness": 45}]
                    },
                    {
                        "featureType": "road",
                        "elementType": "geometry.fill",
                        "stylers": [{"color": "#eeeeee"}]
                    },
                    {
                        "featureType": "road",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#7b7b7b"}]
                    },
                    {
                        "featureType": "road",
                        "elementType": "labels.text.stroke",
                        "stylers": [{"color": "#ffffff"}]
                    },
                    {
                        "featureType": "road.highway",
                        "elementType": "all",
                        "stylers": [{"visibility": "simplified"}]
                    },
                    {
                        "featureType": "road.arterial",
                        "elementType": "labels.icon",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "transit",
                        "elementType": "all",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "water",
                        "elementType": "all",
                        "stylers": [{"color": "#46bcec"}, {"visibility": "on"}]
                    },
                    {
                        "featureType": "water",
                        "elementType": "geometry.fill",
                        "stylers": [{"color": "#c8d7d4"}]
                    },
                    {
                        "featureType": "water",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#070707"}]
                    },
                    {
                        "featureType": "water",
                        "elementType": "labels.text.stroke",
                        "stylers": [{"color": "#ffffff"}]
                    }
                ]
            });
            
            // Cargar datos iniciales
            loadDevicesData();
        }

        // Cargar datos de dispositivos desde Firebase
        function loadDevicesData() {
            database.ref('/gps-data').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    devicesData = {};
                    Object.keys(data).forEach(deviceId => {
                        const deviceNode = data[deviceId];
                        // Buscar el √∫ltimo nodo (por timestamp o por orden de claves)
                        let lastLocation = null;
                        let lastTimestamp = 0;
                        Object.values(deviceNode).forEach(child => {
                            // Solo tomar nodos que tengan lat/lng y timestamp
                            if (child.latitude !== undefined && child.longitude !== undefined && child.timestamp) {
                                if (child.timestamp > lastTimestamp) {
                                    lastTimestamp = child.timestamp;
                                    lastLocation = child;
                                }
                            }
                        });
                        if (lastLocation) {
                            devicesData[deviceId] = lastLocation;
                        }
                    });
                    updateDeviceList();
                    updateMapMarkers();
                } else {
                    showError('No se encontraron dispositivos en la base de datos');
                }
            }, (error) => {
                console.error('Error al cargar datos:', error);
                showError('Error al conectar con la base de datos: ' + error.message);
            });
        }

        // Actualizar lista de dispositivos
        function updateDeviceList() {
            const deviceList = document.getElementById('deviceList');
            deviceList.innerHTML = '';

            if (Object.keys(devicesData).length === 0) {
                deviceList.innerHTML = '<p>No hay dispositivos disponibles</p>';
                return;
            }

            Object.keys(devicesData).forEach(deviceId => {
                const device = devicesData[deviceId];
                const deviceCard = createDeviceCard(deviceId, device);
                deviceList.appendChild(deviceCard);
            });
        }

        // Crear tarjeta de dispositivo
        function createDeviceCard(deviceId, device) {
            const card = document.createElement('div');
            card.className = 'device-card';
            card.onclick = () => selectDevice(deviceId);

            const lat = device.latitude || 'N/A';
            const lng = device.longitude || 'N/A';
            const speed = device.speed || 0;
            const altitude = device.altitude || 0;

            card.innerHTML = `
                <div class="device-name">üìç ${deviceId}</div>
                <div class="device-info">
                    <div class="info-row">
                        <span class="info-label">Latitud:</span>
                        <span class="info-value coordinate">${lat}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Longitud:</span>
                        <span class="info-value coordinate">${lng}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Velocidad:</span>
                        <span class="info-value">${speed} km/h</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Altitud:</span>
                        <span class="info-value">${altitude} m</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Actualizado:</span>
                        <span class="info-value timestamp">${device.timestamp ? parseCustomTimestamp(device.timestamp).toLocaleString('es-ES') : 'No disponible'}</span>
                    </div>
                </div>
            `;

            return card;
        }

        // Seleccionar dispositivo
        function selectDevice(deviceId) {
            // Remover selecci√≥n anterior
            document.querySelectorAll('.device-card').forEach(card => {
                card.classList.remove('active');
            });

            // Seleccionar nuevo dispositivo
            event.target.closest('.device-card').classList.add('active');
            selectedDevice = deviceId;

            // Centrar mapa en el dispositivo
            const device = devicesData[deviceId];
            if (device.latitude && device.longitude) {
                map.setCenter({
                    lat: parseFloat(device.latitude),
                    lng: parseFloat(device.longitude)
                });
                map.setZoom(15);

                // Abrir info window del marcador
                if (markers[deviceId]) {
                    markers[deviceId].infoWindow.open(map, markers[deviceId]);
                }
            }
        }

        // Actualizar marcadores en el mapa
        function updateMapMarkers() {
            // Limpiar marcadores existentes
            Object.values(markers).forEach(marker => {
                marker.setMap(null);
                if (marker.infoWindow) {
                    marker.infoWindow.close();
                }
            });
            markers = {};

            // Crear nuevos marcadores
            Object.keys(devicesData).forEach(deviceId => {
                const device = devicesData[deviceId];
                if (device.latitude && device.longitude) {
                    createMarker(deviceId, device);
                }
            });

            // Ajustar vista para mostrar todos los marcadores
            if (Object.keys(markers).length > 0) {
                const bounds = new google.maps.LatLngBounds();
                Object.values(markers).forEach(marker => {
                    bounds.extend(marker.getPosition());
                });
                map.fitBounds(bounds);
            }
        }

        // Crear marcador
        function createMarker(deviceId, device) {
            const position = {
                lat: parseFloat(device.latitude),
                lng: parseFloat(device.longitude)
            };

            const marker = new google.maps.Marker({
                position: position,
                map: map,
                title: deviceId,
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10" fill="#3498db" stroke="#2c3e50"/>
                            <circle cx="12" cy="12" r="3" fill="#ffffff"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(40, 40)
                },
                animation: google.maps.Animation.DROP
            });

            // Crear info window
            const infoWindow = new google.maps.InfoWindow({
                content: createInfoWindowContent(deviceId, device)
            });

            marker.infoWindow = infoWindow;

            // Agregar evento click
            marker.addListener('click', () => {
                // Cerrar otras info windows
                Object.values(markers).forEach(m => {
                    if (m.infoWindow) {
                        m.infoWindow.close();
                    }
                });
                
                infoWindow.open(map, marker);
                selectDeviceById(deviceId);
            });

            markers[deviceId] = marker;
        }

        // Crear contenido del info window
        function createInfoWindowContent(deviceId, device) {
            const speed = device.speed || 0;
            const altitude = device.altitude || 0;

            return `
                <div class="info-window">
                    <h3>üìç ${deviceId}</h3>
                    <div class="detail">
                        <span class="label">Coordenadas:</span><br>
                        ${device.latitude}, ${device.longitude}
                    </div>
                    <div class="detail">
                        <span class="label">Velocidad:</span> ${speed} km/h
                    </div>
                    <div class="detail">
                        <span class="label">Altitud:</span> ${altitude} m
                    </div>
                    <div class="detail">
                        <span class="label">√öltima actualizaci√≥n:</span><br>
                        ${device.timestamp ? parseCustomTimestamp(device.timestamp).toLocaleString('es-ES') : 'No disponible'}
                    </div>
                </div>
            `;
        }

        // Seleccionar dispositivo por ID
        function selectDeviceById(deviceId) {
            document.querySelectorAll('.device-card').forEach(card => {
                card.classList.remove('active');
                if (card.querySelector('.device-name').textContent.includes(deviceId)) {
                    card.classList.add('active');
                    card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
            selectedDevice = deviceId;
        }

        // Mostrar error
        function showError(message) {
            const deviceList = document.getElementById('deviceList');
            deviceList.innerHTML = `<div class="error-message">${message}</div>`;
        }

        // Actualizar datos manualmente
        function refreshData() {
            document.getElementById('deviceList').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Actualizando datos...</p>
                </div>
            `;
            loadDevicesData();
        }

        // Cargar Google Maps API
        function loadGoogleMapsAPI() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyD9EbFupUbBXfffpJvMN3O4f0q3dMzByQs&callback=initMap`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }

        // Inicializar cuando se carga la p√°gina
        window.onload = function() {
            loadGoogleMapsAPI();
        };

        function parseCustomTimestamp(ts) {
            // ts es un n√∫mero como 250710025945 (DDMMYYhhmmss)
            const str = ts.toString().padStart(12, '0');
            const day = parseInt(str.slice(0, 2), 10);
            const month = parseInt(str.slice(2, 4), 10) - 1; // Mes en JS es 0-indexado
            const year = 2000 + parseInt(str.slice(4, 6), 10);
            const hour = parseInt(str.slice(6, 8), 10);
            const min = parseInt(str.slice(8, 10), 10);
            const sec = parseInt(str.slice(10, 12), 10);
            return new Date(year, month, day, hour, min, sec);
        }
    </script>
</body>
</html>